<header>
  <label class="btn">
    <strong>Select ZIP</strong>
    <input id="zip" type="file" accept=".zip" />
  </label>
  <select id="fileSelect"></select>
  <div id="status">No ZIP loaded</div>
</header>

<iframe id="stage" sandbox="allow-scripts allow-downloads" referrerpolicy="no-referrer"></iframe>

<!-- fflate: ZIP extraction library -->
<script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.js"></script>

<script>
  const statusEl = document.getElementById('status');
  const stage = document.getElementById('stage');
  const input = document.getElementById('zip');
  const fileSelect = document.getElementById('fileSelect');

  let entries = {}, map = {};

  function launchFile(name) {
    // Decode file as text (works for HTML, CSS, JS, etc.)
    const raw = new TextDecoder().decode(entries[name]);
    const html = rewriteHtmlPaths(raw, (p) => {
      const baseDir = name.includes('/') ? name.slice(0, name.lastIndexOf('/') + 1) : '';
      const rel = (baseDir + p)
        .replace(/\\/g,'/')
        .replace(/\/\.\//g,'/')
        .replace(/\/[^\/]+\/\.\.\//g,'/');
      return map[rel] || map[p] || null;
    });
    launchSite(html, map);
    statusEl.textContent = `Running: ${name}`;
  }

  fileSelect.addEventListener('change', () => {
    const name = fileSelect.value;
    if (name) launchFile(name);
  });

  input.addEventListener('change', async () => {
    const file = input.files?.[0];
    if (!file) return;
    statusEl.textContent = 'Reading ZIPâ€¦';

    const buf = new Uint8Array(await file.arrayBuffer());

    // ðŸ”‘ unzip with fflate
    const unzipped = fflate.unzipSync(buf);

    // Build entries and Blob URLs
    entries = {};
    map = {};
    for (const [name, bytes] of Object.entries(unzipped)) {
      entries[name] = bytes;
      const type = "application/octet-stream"; // refine MIME if needed
      map[name] = URL.createObjectURL(new Blob([bytes], { type }));
    }

    // Populate dropdown with ALL files
    fileSelect.innerHTML = '';
    Object.keys(entries).forEach(n => {
      const opt = document.createElement('option');
      opt.value = n;
      opt.textContent = n;
      fileSelect.appendChild(opt);
    });

    if (Object.keys(entries).length) {
      fileSelect.value = Object.keys(entries)[0];
      launchFile(Object.keys(entries)[0]); // auto-launch first file
    } else {
      statusEl.textContent = 'No files found in ZIP.';
    }
  });
</script>
