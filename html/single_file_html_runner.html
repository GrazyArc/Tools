<header>
  <label class="btn">
    <strong>Select ZIP</strong>
    <input id="zip" type="file" accept=".zip" />
  </label>
  <select id="htmlSelect"></select>
  <div id="status">No ZIP loaded</div>
</header>
<iframe id="stage" sandbox="allow-scripts allow-downloads" referrerpolicy="no-referrer"></iframe>

<script>
  const statusEl = document.getElementById('status');
  const stage = document.getElementById('stage');
  const input = document.getElementById('zip');
  const htmlSelect = document.getElementById('htmlSelect');

  let entries = {}, map = {};

  // Helper: get lowercase extension
  function ext(name) {
    const i = name.lastIndexOf(".");
    return i === -1 ? "" : name.slice(i+1).toLowerCase();
  }

  function launchHtml(name) {
    const raw = new TextDecoder().decode(entries[name]);
    const html = rewriteHtmlPaths(raw, (p) => {
      const baseDir = name.includes('/') ? name.slice(0, name.lastIndexOf('/') + 1) : '';
      const rel = (baseDir + p).replace(/\\/g,'/').replace(/\/\.\//g,'/').replace(/\/[^\/]+\/\.\.\//g,'/');
      return map[rel] || map[p] || null;
    });
    launchSite(html, map);
    statusEl.textContent = `Running: ${name}`;
  }

  htmlSelect.addEventListener('change', () => {
    const name = htmlSelect.value;
    if (name) launchHtml(name);
  });

  input.addEventListener('change', async () => {
    const file = input.files?.[0];
    if (!file) return;
    statusEl.textContent = 'Reading ZIP…';
    const buf = new Uint8Array(await file.arrayBuffer());

    // TODO: unzipSync logic here → fill entries
    // TODO: build map of Blob URLs here

    // Detect HTML files (case-insensitive, includes .htm)
    const htmlFiles = Object.keys(entries).filter(n => {
      const e = ext(n);
      return e === 'html' || e === 'htm';
    });

    htmlSelect.innerHTML = '';
    htmlFiles.forEach(n => {
      const opt = document.createElement('option');
      opt.value = n;
      opt.textContent = n;
      htmlSelect.appendChild(opt);
    });

    if (htmlFiles.length) {
      htmlSelect.value = htmlFiles[0];
      launchHtml(htmlFiles[0]);
    } else {
      statusEl.textContent = 'No HTML files found in ZIP.';
    }
  });
</script>
